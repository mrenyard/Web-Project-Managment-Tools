#!/bin/bash -eu

if [[ "$#" -lt 2 ]]; then
  echo "Usage: addVirtualHost PROJECT_NAME DOMAIN_NAME";
  exit 1;
fi

declare -r PROJECT_NAME=${1};
declare -r DOMAIN_NAME=${2};
LAN=; LAN_HOSTNAME=; if [[ "${HOSTNAME}" == *lan ]]; then LAN=".lan"; LAN_HOSTNAME=`echo ${HOSTNAME} | sed 's/\(.*\)-lan/\1.lan/'`; fi

if [[ "${HOME}" == "/root" ]]; then
  echo "${HOME} IS AN INVALID HOME PATH!";
  read -p "Enter username: " USERNAME;
  HOME=`echo "/home/${USERNAME}"`;
fi

echo "SETTING UP NEW VIRTUAL HOST: ${DOMAIN_NAME}"
echo "  ${DOMAIN_NAME}"; `/bin/ln -s "${HOME}/Projects/${PROJECT_NAME}/www" "/var/www/${DOMAIN_NAME}"`;
echo "  style.${DOMAIN_NAME}"; `/bin/ln -s "${HOME}/Projects/${PROJECT_NAME}/www/assets/style" "/var/www/style.${DOMAIN_NAME}"`;
echo "  func.${DOMAIN_NAME}"; `/bin/ln -s "${HOME}/Projects/${PROJECT_NAME}/www/assets/func" "/var/www/func.${DOMAIN_NAME}"`;
echo "  media.${DOMAIN_NAME}"; `/bin/ln -s "${HOME}/Projects/${PROJECT_NAME}/www/assets/media" "/var/www/media.${DOMAIN_NAME}"`;
echo "  dev.${DOMAIN_NAME}"; `/bin/ln -s "${HOME}/Projects/${PROJECT_NAME}/www" "/var/www/dev.${DOMAIN_NAME}"`;

VIRTUAL_HOST_FILE=`echo "${PROJECT_NAME}" | sed 's/ //g'`;
declare -r VIRTUAL_HOST_FILE="${VIRTUAL_HOST_FILE,,}";

`/bin/cp "/etc/webshop/skel/vhost${LAN}/base.txt" "/etc/apache2/sites-available/${VIRTUAL_HOST_FILE}.conf"`;
/usr/bin/virtualhost-edit ${VIRTUAL_HOST_FILE} ${DOMAIN_NAME};

exit 0;
