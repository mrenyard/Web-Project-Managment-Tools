#!/bin/bash -eu

if [ "$#" -lt 2 ] || [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
  echo "Usage: copy-current-website \"PROJECT_NAME\" COPY_DOMAIN";
  exit 2;
fi

PROJECT_NAME=${1};
declare -r COPY_DOMAIN=${2};
declare -r PROJECT_NAME=`echo ${PROJECT_NAME} | sed 's/"//g'`;
HOST=`echo "${PROJECT_NAME}" | sed 's/ //g' | sed 's/\//-/g'`;
declare -r HOST="${HOST,,}";
declare -r FULL_DOMAIN=`virtualhost-get-domain ${HOST}`;
declare -r DOMAIN=`echo ${FULL_DOMAIN} | sed -e "s/.tld//g" -e "s/.${HOSTNAME}.lan//g"`;

if [ $USER == 'root' ]; then USER=$SUDO_USER; HOME="/home/${SUDO_USER}"; fi
if [[ "${HOME}" == "/root" || "${HOME}" == "/home/root" ]]; then
  echo "${HOME} IS AN INVALID HOME PATH!";
  read -p "Enter username: " USER;
  HOME=`echo "/home/${USER}"`;
fi
export HOME;

sudo echo "COPYING: https://${COPY_DOMAIN}/ TO '${HOME}/Projects/${PROJECT_NAME}/copy'"
sudo httrack "${COPY_DOMAIN}" -O "/tmp/${HOST}" -v;

if [[ ! -d "${HOME}/Projects/${PROJECT_NAME}/copy" ]]; then
  sudo mkdir "${HOME}/Projects/${PROJECT_NAME}/copy";
  sudo chown -R ${USER}:${USER} "${HOME}/Projects/${PROJECT_NAME}/copy";
  sudo chmod -R 755 "${HOME}/Projects/${PROJECT_NAME}/copy";
fi
sudo mv -f /tmp/${HOST}/${COPY_DOMAIN}/* "${HOME}/Projects/${PROJECT_NAME}/copy/";
sudo rm -R "/tmp/${HOST}";

if [[ ! -L /var/www/copy.${DOMAIN} ]]; then
  echo "  ADDING SUB DOMAIN: copy.${DOMAIN}";
  sudo /bin/ln -s "${HOME}/Projects/${PROJECT_NAME}/copy" "/var/www/copy.${HOST}";
  sudo chown -R www-data:www-data "/var/www/copy.${HOST}";
  sudo chmod -R 755 "/var/www/copy.${HOST}";
fi

if [[ ! -z $(grep "ServerName copy" "/etc/apache2/sites-available/${HOST}.conf") ]]; then
  echo " VIRTUAL HOST FILE is UP TO DATE";
else
  sudo virtualhost-append-copy ${HOST}
fi

exit 0;
