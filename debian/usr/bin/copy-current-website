#!/bin/bash -eu

if [[ "$#" -lt 2 ]]; then
  echo "Usage: copy-current-website PROJECT_NAME DOMAIN_TO_COPY";
  exit 2;
fi

declare -r PROJECT_NAME=${1};
declare -r DOMAIN_TO_COPY=${2};
VIRTUAL_HOST_FILE=`echo "${PROJECT_NAME}" | sed 's/ //g' | sed 's/\//-/g'`;
declare -r VIRTUAL_HOST_FILE="${VIRTUAL_HOST_FILE,,}";
declare -r FULL_DOMAIN=`virtualhost-get-domain ${VIRTUAL_HOST_FILE}`;
declare -r DOMAIN=`echo ${FULL_DOMAIN} | sed -e "s/.tld//g" -e "s/.${HOSTNAME}//g"`;

sudo echo "COPYING: https://${DOMAIN_TO_COPY}/ TO '${HOME}/Projects/${PROJECT_NAME}/copy'"
httrack "${DOMAIN_TO_COPY}" -O "/tmp/${VIRTUAL_HOST_FILE}" -v

if [[ -d "${HOME}/Projects/${PROJECT_NAME}/copy" ]]; then
 sudo rm -R "${HOME}/Projects/${PROJECT_NAME}/copy";
fi
sudo mv "/tmp/${VIRTUAL_HOST_FILE}/${DOMAIN_TO_COPY}" "${HOME}/Projects/${PROJECT_NAME}/copy";
sudo rm -R "/tmp/${VIRTUAL_HOST_FILE}";

if [[ ! -L /var/www/copy.${DOMAIN} ]]; then
  echo "  ADDING SUB DOMAIN: copy.${DOMAIN}";
  sudo /bin/ln -s "${HOME}/Projects/${PROJECT_NAME}/copy" "/var/www/copy.${DOMAIN}";
fi

if grep -q "ServerName copy" /etc/apache2/sites-available/${VIRTUAL_HOST_FILE}; then
  echo " VIRTUAL HOST FILE is UP TO DATE";
 else
  sudo virtualhost-append-copy ${VIRTUAL_HOST_FILE} ${FULL_DOMAIN}
fi

exit 0;
