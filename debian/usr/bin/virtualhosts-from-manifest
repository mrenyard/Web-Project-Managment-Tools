#!/bin/bash -eu

if [ $USER == 'root' ]; then USER=$SUDO_USER; HOME="/home/${SUDO_USER}"; fi
while [[ "${HOME}" == "/root" || ! -d "${HOME}" ]]; do
  echo "USER HOME PATH ${HOME} IS INVALID!";
  read -p "Enter username: " USER
  HOME=`echo "/home/${USER}"`;
done
export HOME USER;

if [[ ! -f ${HOME}/Projects/.manifest ]]; then
  echo -e "  ...\e[0;31mFAILED!\e[0m MANIFEST file not found!";
  exit 1;
fi

echo "CHECKING manifest file for details";

while read DOMAIN PROJECT_NAME; do
  PROJECT_NAME=`echo ${PROJECT_NAME} | sed 's/"//g'`;
  echo "  ADDING ${DOMAIN} \"${PROJECT_NAME}\"";
  bash -c "virtualhost \"${PROJECT_NAME}\" add ${DOMAIN} --from-manifest";
done < ${HOME}/Projects/.manifest

sudo systemctl restart apache2;
exit 0;
