#!/bin/bash -eu

if [ $USER == 'root' ]; then USER=$SUDO_USER; HOME="/home/${SUDO_USER}"; fi
if [[ "${HOME}" == "/root" || "${HOME}" == "/home/root" ]]; then
  echo "${HOME} IS AN INVALID HOME PATH!";
  read -p "Enter username: " USERNAME;
  HOME=`echo "/home/${USERNAME}"`;
fi
export HOME;

if [[ ! -f ${HOME}/Projects/.manifest ]]; then
  echo "  ...FAILED! MANIFEST file not found!";
  exit 1;
fi

echo "CHECKING manifest file for details";

while read DOMAIN PROJECT_NAME; do
  PROJECT_NAME=`echo ${PROJECT_NAME} | sed 's/"//g'`;
  echo "  ADDING ${DOMAIN} \"${PROJECT_NAME}\"";
  bash -c "virtualhost \"${PROJECT_NAME}\" add ${DOMAIN} --from-manifest";
done < ${HOME}/Projects/.manifest

sudo systemctl restart apache2;
exit 0;
