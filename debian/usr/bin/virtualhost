#!/bin/bash -eu

declare -r USAGE_STATEMENT="Usage: virtualhost PROJECT_NAME remove|[add DOMAIN[ --from-manifest]]";
if [[ "$#" -lt 2 ]]; then echo ${USAGE_STATEMENT}; exit 1; fi

declare -r PROJECT_NAME=${1}
declare -r SWITCH=${2};

LAN=FALSE; LAN_HOSTNAME=; if [[ "${HOSTNAME}" == *.lan ]]; then LAN=TRUE; LAN_HOSTNAME=${HOSTNAME}; fi
VIRTUAL_HOST_FILE=`echo "${PROJECT_NAME}" | sed 's/ //g' | sed 's/\//-/g'`;
declare -r VIRTUAL_HOST_FILE="${VIRTUAL_HOST_FILE,,}";

if [ $USER == 'root' ]; then USER=$SUDO_USER; HOME="/home/${SUDO_USER}"; fi
if [[ "${HOME}" == "/root" || "${HOME}" == "/home/root" ]]; then
  echo "${HOME} IS AN INVALID HOME PATH!";
  read -p "Enter username: " USERNAME;
  HOME=`echo "/home/${USERNAME}"`;
fi
export HOME;

case ${SWITCH} in
  "add")
    if [[ "$#" -gt 2 ]]; then
      declare -r DOMAIN=${3};
    else
      echo "  ...FAILED! DOMAIN requiered!";
      exit 2;
    fi
    if [[ $DOMAIN == *.* ]]; then
      FULL_DOMAIN=${DOMAIN,,};
    else
      if [[ "${LAN}" == TRUE ]]; then
        FULL_DOMAIN="${DOMAIN,,}.${LAN_HOSTNAME,,}";
      else
        FULL_DOMAIN="${DOMAIN,,}.${HOSTNAME,,}.lan";
      fi
    fi

    UPDATE_MANIFEST=true;
    if [[ "$#" -gt 3 ]]; then
     if [ ${4} != "--from-manifest" ]; then echo ${USAGE_STATEMENT}; exit 1; fi
     UPDATE_MANIFEST=false;
    fi

    sudo echo "SETTING UP NEW VIRTUAL HOST: ${VIRTUAL_HOST_FILE}";
    if [[ ! -L /var/www/${DOMAIN} ]]; then
      echo "  ADDING symbolic links";
      echo "    ${DOMAIN}"; sudo /bin/ln -s "${HOME}/Projects/${PROJECT_NAME}/www" "/var/www/${DOMAIN}";
      echo "    style.${DOMAIN}"; sudo /bin/ln -s "${HOME}/Projects/${PROJECT_NAME}/www/assets/style" "/var/www/style.${DOMAIN}";
      echo "    func.${DOMAIN}"; sudo /bin/ln -s "${HOME}/Projects/${PROJECT_NAME}/www/assets/func" "/var/www/func.${DOMAIN}";
      echo "    media.${DOMAIN}"; sudo /bin/ln -s "${HOME}/Projects/${PROJECT_NAME}/www/assets/media" "/var/www/media.${DOMAIN}";
      echo "    dev.${DOMAIN}"; sudo /bin/ln -s "${HOME}/Projects/${PROJECT_NAME}/www" "/var/www/dev.${DOMAIN}";
    fi
    if [[ ! -f /etc/apache2/sites-available/${VIRTUAL_HOST_FILE} ]]; then
      echo "  ADDING virtualhost file: '/etc/apache2/sites-available/${VIRTUAL_HOST_FILE}'";
      sudo /bin/cp /etc/webshop/skel/vhost/base.txt /etc/apache2/sites-available/${VIRTUAL_HOST_FILE}.conf;
      echo "virtualhost-edit ${VIRTUAL_HOST_FILE} ${FULL_DOMAIN};";
      sudo virtualhost-edit ${VIRTUAL_HOST_FILE} ${FULL_DOMAIN};
    fi
    if $UPDATE_MANIFEST; then
      echo "  UPDATING MANIFEST";
      echo "${DOMAIN} ${PROJECT_NAME}" >> ${HOME}/Projects/.manifest;
    fi
    sudo chown -R www-data:www-data /var/www/;
    sudo a2ensite ${VIRTUAL_HOST_FILE}.conf;
    echo "NEW VIRTUAL HOST SETUP COMPLETE!";
    ;;

  "remove")
    sudo echo "REMOVING VIRTUAL HOST: ${VIRTUAL_HOST_FILE}";
    sudo a2dissite ${VIRTUAL_HOST_FILE};
    if [[ -L /var/www/${VIRTUAL_HOST_FILE} ]]; then
      echo "  REMOVING symbolic links";
      sudo rm /var/www/*${VIRTUAL_HOST_FILE};
    fi
    if [[ -f /etc/apache2/sites-available/${VIRTUAL_HOST_FILE} ]]; then
      echo "  REMOVING virtualhost file: '/etc/apache2/sites-available/${VIRTUAL_HOST_FILE}'";
      sudo rm /etc/apache2/sites-available/${VIRTUAL_HOST_FILE}.conf;
    fi
    echo "  UPDATING MANIFEST";
    SAFE_PROJECT_NAME=`echo "${PROJECT_NAME}" | sed -e 's:\/:\\\/:g'`
    /bin/sed -i "/${VIRTUAL_HOST_FILE} ${SAFE_PROJECT_NAME}/d" ${HOME}/Projects/.manifest
    echo "VIRTUAL HOST REMOVAL COMPLETE!";
    ;;

  *)
    echo ${USAGE_STATEMENT}; exit 1;
    ;;
esac

sudo systemctl reload apache2.service;
exit 0;
