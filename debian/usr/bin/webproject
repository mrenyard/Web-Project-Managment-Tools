#!/bin/bash -eu

if [ "$#" -lt 2 ] || [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
  webproject-usage; exit 1;
fi
declare -r NULL=;
declare -r PROJECT_NAME=${1};
case ${2} in
  "new") ;&
  "extend") ;&
  "update") ;&
  "reset")
    declare -r PROCESS_TYPE=${2};
    ;;
  *)
    webproject-usage; exit 1;
    ;;
esac

shift 2;
declare DOMAIN=;
declare APPLICATION_NAME=false;
declare COPY_DOMAIN=;
while (( "$#" )); do
  case $1 in
    "--domain")
      DOMAIN=${2};
      shift 2;
      ;;
    "--application")
      APPLICATION_NAME=true;
      shift 1;
      ;;
    "--copy")
      COPY_DOMAIN=${2};
      shift 2;
      ;;
    *)
      webproject-usage; exit 1;
      ;;
  esac
done

if [ $USER == 'root' ]; then USER=$SUDO_USER; HOME="/home/${SUDO_USER}"; fi
HOST=`echo "${PROJECT_NAME}" | sed 's/ //g' | sed 's/"//g'`;
declare -r HOST=${HOST,,};

case ${PROCESS_TYPE} in
  "new" )
    sudo echo "BUILDING: '${HOME}/Projects/${PROJECT_NAME}'";

    if [[ -d "${HOME}/Projects/${PROJECT_NAME}" ]]; then
      echo -e "  ...\e[0;31mFAILED!\e[0m Project already exists!";
      exit 3;
    fi
    mkdir -pv "${HOME}/Projects/${PROJECT_NAME}/";
    sudo cp -dR /etc/webshop/skel/base/* "${HOME}/Projects/${PROJECT_NAME}/";

    if [[ "${DOMAIN}" == "${NULL}" ]]; then
      DOMAIN=`echo "${PROJECT_NAME,,}" | sed 's/ //g'`;
    fi
    virtualhost "${PROJECT_NAME}" add ${DOMAIN};

    declare -r TAG_DOMAIN=`virtualhost-get-domain "${HOST}"`;
    
    declare -r TAG_SITE_ID=`echo "${TAG_DOMAIN}" | sed 's/\./-/g'`;

    for i in $(ls "${HOME}/Projects/${PROJECT_NAME}/www/assets/style/docs/"); do sed -i "s/SITE_ID/${TAG_SITE_ID}/g" "${HOME}/Projects/${PROJECT_NAME}/www/assets/style/docs/${i}"; done;
    for j in $(ls "${HOME}/Projects/${PROJECT_NAME}/www/assets/style/docs/"); do sed -i "s/DOMAIN/${TAG_DOMAIN}/g" "${HOME}/Projects/${PROJECT_NAME}/www/assets/style/docs/${j}"; done;
    for k in $(ls "${HOME}/Projects/RAMP/www/assets/func/docs/" | grep ".scratch$"); do sed -i "s/SITE_ID/${TAG_SITE_ID}/g" "${HOME}/Projects/${PROJECT_NAME}/www/assets/func/docs/${k}"; done;
    for l in $(ls "${HOME}/Projects/RAMP/www/assets/func/docs/" | grep ".scratch$"); do sed -i "s/DOMAIN/${TAG_DOMAIN}/g" "${HOME}/Projects/${PROJECT_NAME}/www/assets/func/docs/${l}"; done;
    for m in $(ls "${HOME}/Projects/RAMP/www/assets/func/" | grep ".html$"); do sed -i "s/SITE_ID/${TAG_SITE_ID}/g" "${HOME}/Projects/${PROJECT_NAME}/www/assets/func/${m}"; done;
    for n in $(ls "${HOME}/Projects/RAMP/www/assets/func/" | grep ".html$"); do sed -i "s/DOMAIN/${TAG_DOMAIN}/g" "${HOME}/Projects/${PROJECT_NAME}/www/assets/func/${n}"; done;
    sed -i "s/SITE_ID/${TAG_SITE_ID}/g" "${HOME}/Projects/${PROJECT_NAME}/www/assets/media/index.html";
    sed -i "s/DOMAIN/${TAG_DOMAIN}/g" "${HOME}/Projects/${PROJECT_NAME}/www/assets/media/index.html";

    if [[ ${APPLICATION_NAME} == true ]]; then
      echo "ADDING APPLICATION SKELETON: '${HOME}/Projects/${PROJECT_NAME}'";
      sudo /bin/cp -dR /etc/webshop/skel/application/* "${HOME}/Projects/${PROJECT_NAME}";
    fi

    if [[ "${COPY_DOMAIN}" != "${NULL}" ]]; then
      copy-current-website "${PROJECT_NAME}" ${COPY_DOMAIN};
    fi

    echo "RELOADING WEB SERVER";
    sudo systemctl reload apache2.service
    ;;

  "extend" )
    if [[
      ( ${APPLICATION_NAME} == true) &&
      (
        (-d "${HOME}/Projects/${PROJECT_NAME}/code/") ||
        (-d "${HOME}/Projects/${PROJECT_NAME}/02-userRequierments/") ||
        (-d "${HOME}/Projects/${PROJECT_NAME}/04-Systemdesign/")
      )
    ]]; then
      echo -e "  ...\e[0;31mFAILED!\e[0m there are indication that a web application skeleton has already been added!";
      echo "  If you wish to 'update' or 'reset' the web application skeleton please use the correct command.";
      exit 4;
    fi

    if [[ ("${COPY_DOMAIN}" != "${NULL}") && (-d "${HOME}/Projects/${PROJECT_NAME}/copy") ]]; then
      echo -e "  ...\e[0;31mFAILED!\e[0m '${HOME}/Projects/${PROJECT_NAME}/copy' already exists!";
      echo "  If you wish to 'update/reset' the copy please use one of the correct commands.";
      exit 5;
    fi

    sudo echo "EXTENDING RELEVANT FEATURE(S)";

    if [[ "${DOMAIN}" != "${NULL}" ]]; then
      FULL_DOMAIN=`get-full-domain ${DOMAIN}`;
      echo "ADDING ALIAS ${FULL_DOMAIN} TO VIRTUAL HOST";
      sudo /bin/sed "3i\  ServerAlias ${FULL_DOMAIN}" "/etc/apache2/sites-available/${HOST}.conf" > "/tmp/${HOST}-part";
      sudo /bin/sed "8i\  ServerAlias ${FULL_DOMAIN}" "/tmp/${HOST}-part" > "/tmp/${HOST}";
      sudo /bin/mv "/tmp/${HOST}" "/etc/apache2/sites-available/${HOST}.conf";
      sudo /bin/rm "/tmp/${HOST}-part";
    fi

    if [[ ${APPLICATION_NAME} == true ]]; then
      echo "ADDING APPLICATION SKELETON: '${HOME}/Projects/${PROJECT_NAME}'";
      `sudo /bin/cp -dR /etc/webshop/skel/application/* "${HOME}/Projects/${PROJECT_NAME}"`;
    fi

    if [[ "${COPY_DOMAIN}" != "${NULL}" ]]; then
      copy-current-website "${PROJECT_NAME}" ${COPY_DOMAIN};
    fi

    echo "RELOADING WEB SERVER";
    sudo systemctl reload apache2.service
    ;;

  "update" )
    sudo echo "UPDATING RELEVANT FEATURE(S)";

    if [[ "${DOMAIN}" != "${NULL}" ]]; then
      FULL_DOMAIN=`get-full-domain ${DOMAIN}`;
      echo "UPDATING PRIMARY DOMAIN NAME TO: ${FULL_DOMAIN}";
      sudo virtualhost-edit ${HOST} ${FULL_DOMAIN};
      echo "RELOADING WEB SERVER";
      sudo systemctl reload apache2.service
    fi

    if [[ ${APPLICATION_NAME} == true ]]; then
      echo "UPDATING APPLICATION SKELETON: '${HOME}/Projects/${PROJECT_NAME}'";
      sudo /bin/cp -dRuvi /etc/webshop/skel/application/* "${HOME}/Projects/${PROJECT_NAME}";
    fi

    if [[ "${COPY_DOMAIN}" != "${NULL}" ]]; then
      sudo /bin/rm -rf "${HOME}/Projects/${PROJECT_NAME}/copy";
      copy-current-website "${PROJECT_NAME}" ${COPY_DOMAIN};
    fi
    ;;

  "reset" )
    sudo echo "RESETING RELEVANT FEATURE(S)";

    if [[ "${DOMAIN}" != "${NULL}" ]]; then
      echo "Reseting the primary domain name for '${PROJECT_NAME}' will DELETE all aliases.";
      read -p "ARE YOU SURE YOU WISH TO CONTINUE WITH THIS ACTION (y/n)? " -n 1 -r
      if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "\n ...RESETTING PRIMARY DOMAIN NAME.";
        sudo virtualhost "${PROJECT_NAME}" remove;
        sudo virtualhost "${PROJECT_NAME}" add ${DOMAIN};
        if [[ -d "${HOME}/Projects/${PROJECT_NAME}/copy" ]]; then
          sudo /bin/ln -s "${HOME}/Projects/${PROJECT_NAME}/copy" "/var/www/copy.${HOST}";
          sudo virtualhost-append-copy ${HOST};
        fi
        echo "RELOADING WEB SERVER";
        sudo service apache2 reload;
        else
          echo -e "\n ...SKIPPING PRIMARY DOMAIN NAME RESET.";
      fi
      echo;
    fi

    if [[ ${APPLICATION_NAME} == true ]]; then
      echo "Reseting web application skeleton '${HOME}/Projects/${PROJECT_NAME}', will REMOVE developer added files.";
      read -p "ARE YOU SURE YOU WISH TO CONTINUE WITH THIS ACTION (y/n)? " -n 1 -r
      if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "\n ...RESETTING WEB APPLICATION SKELETON.";
        sudo /bin/rm -f "${HOME}/Projects/${PROJECT_NAME}/www/controller.php";
        sudo /bin/rm -f "${HOME}/Projects/${PROJECT_NAME}/www/load.ini.php";
        sudo /bin/rm -f "${HOME}/Projects/${PROJECT_NAME}/www/make.scratch";
        sudo /bin/rm -fr "${HOME}/Projects/${PROJECT_NAME}/local/ramp/";
        sudo /bin/rm -fr "${HOME}/Projects/${PROJECT_NAME}/make/";
        if [ -f "${HOME}/Projects/${PROJECT_NAME}/ramp.ini" ]; then
          read -p "  ...Do you also wish to reset your local (ramp.ini) configuration (y/n)? " -n 1 -r
          if [[ $REPLY =~ ^[Yy]$ ]]; then
            sudo /bin/rm -f "${HOME}/Projects/${PROJECT_NAME}/ramp.ini";
          fi
        fi
        /bin/cp -dRf /etc/webshop/skel/application/* "${HOME}/Projects/${PROJECT_NAME}";
        else
          echo -e "\n ...SKIPPING WEB APPLICATION SKELETON RESET.";
      fi
      echo;
    fi

    if [[ "${COPY_DOMAIN}" != "${NULL}" ]]; then
      copy-current-website "${PROJECT_NAME}" ${COPY_DOMAIN};
    fi
    ;;
esac

echo "PROCESS SUCCESFULLY COMPLETED!";
exit 0;
