#!/bin/bash -eu

if [ "$#" -lt 2 ]; then
  webproject-usage; exit 1;
fi
declare -r NULL=;
declare -r PROJECT_NAME=${1};
case ${2} in
  "new") ;&
  "extend") ;&
  "update") ;&
  "reset")
    declare -r PROCESS_TYPE=${2};
    ;;
  *)
    webproject-usage; exit 1;
    ;;
esac

shift 2;
declare DOMAIN=;
declare APPLICATION_NAME=;
declare COPY_DOMAIN=;
while (( "$#" )); do
  case $1 in
    "--domain")
      DOMAIN=${2};
      shift 2;
      ;;
    "--application")
      APPLICATION_NAME=TRUE;
      shift 1;
      ;;
    "--copy")
      COPY_DOMAIN=${2};
      shift 2;
      ;;
    *)
      webproject-usage; exit 1;
      ;;
  esac
done

if [ $USER == 'root' ]; then USER=$SUDO_USER; HOME="/home/${SUDO_USER}"; fi
HOST=`echo "${PROJECT_NAME}" | sed 's/ //g' | sed 's/"//g'`;
declare -r HOST=${HOST,,};

case ${PROCESS_TYPE} in
  "new" )
    sudo echo "BUILDING: '${HOME}/Projects/${PROJECT_NAME}'";

    if [[ -d "${HOME}/Projects/${PROJECT_NAME}" ]]; then
      echo "  ...FAILED! Project already exists!";
      exit 3;
    fi
    /bin/mkdir -pv "${HOME}/Projects/${PROJECT_NAME}";
    /bin/cp -dR /etc/webshop/skel/base/* "${HOME}/Projects/${PROJECT_NAME}";

    if [[ "${DOMAIN}" == "${NULL}" ]]; then
      DOMAIN=`echo "${PROJECT_NAME,,}" | sed 's/ //g'`;
    fi
    virtualhost "${PROJECT_NAME}" add ${DOMAIN};

    if [[ ${APPLICATION_NAME} != TRUE ]]; then
      echo "ADDING APPLICATION SKELETON: '${HOME}/Projects/${PROJECT_NAME}'";
      /bin/cp -dR /etc/webshop/skel/application/* "${HOME}/Projects/${PROJECT_NAME}";
    fi

    if [[ "${COPY_DOMAIN}" != "${NULL}" ]]; then
      copy-current-website "${PROJECT_NAME}" ${COPY_DOMAIN};
    fi

    echo "RELOADING WEB SERVER";
    sudo service apache2 reload;
    ;;

  "extend" )
    if [[
      ( ${APPLICATION_NAME} = TRUE) &&
      (
        (-d "${HOME}/Projects/${PROJECT_NAME}/code/") ||
        (-d "${HOME}/Projects/${PROJECT_NAME}/02-userRequierments/") ||
        (-d "${HOME}/Projects/${PROJECT_NAME}/04-Systemdesign/")
      )
    ]]; then
      echo "  ...FAILED! there are indication that a web application skeleton has already been added!";
      echo "  If you wish to 'update' or 'reset' the web application skeleton please use the correct command.";
      exit 4;
    fi

    if [[ ("${COPY_DOMAIN}" != "${NULL}") && (-d "${HOME}/Projects/${PROJECT_NAME}/copy") ]]; then
      echo "  ...FAILED! '${HOME}/Projects/${PROJECT_NAME}/copy' already exists!";
      echo "  If you wish to 'update/reset' the copy please use one of the correct commands.";
      exit 5;
    fi

    sudo echo "EXTENDING RELEVANT FEATURE(S)";

    if [[ "${DOMAIN}" != "${NULL}" ]]; then
      echo "ADDING ALIAS ${DOMAIN} TO VIRTUAL HOST";
      sudo /bin/sed "4i\  ServerAlias ${DOMAIN}" "/etc/apache2/sites-available/${HOST}" > "/tmp/${HOST}";
      sudo /bin/mv "/tmp/${HOST}" "/etc/apache2/sites-available/${HOST}";
    fi

    if [[ ${APPLICATION_NAME} = TRUE ]]; then
      echo "ADDING APPLICATION SKELETON: '${HOME}/Projects/${PROJECT_NAME}'";
      `/bin/cp -dR /etc/webshop/skel/application/* "${HOME}/Projects/${PROJECT_NAME}"`;
    fi

    if [[ "${COPY_DOMAIN}" != "${NULL}" ]]; then
      copy-current-website "${PROJECT_NAME}" ${COPY_DOMAIN};
    fi

    echo "RELOADING WEB SERVER";
    sudo a2dissite ${HOST} && sudo service apache2 reload;
    ;;

  "update" )
    sudo echo "UPDATING RELEVANT FEATURE(S)";

    if [[ "${DOMAIN}" != "${NULL}" ]]; then
      echo "UPDATING PRIMARY DOMAIN NAME TO: ${DOMAIN}";
      sudo virtualhost-edit ${HOST} ${DOMAIN};
      echo "RELOADING WEB SERVER";
      sudo service apache2 reload;
    fi

    if [[ ${APPLICATION_NAME} = TRUE ]]; then
      echo "UPDATING APPLICATION SKELETON: '${HOME}/Projects/${PROJECT_NAME}'";
      /bin/cp -dRuvi /etc/webshop/skel/application/* "${HOME}/Projects/${PROJECT_NAME}";
    fi

    if [[ "${COPY_DOMAIN}" != "${NULL}" ]]; then
      copy-current-website "${PROJECT_NAME}" ${COPY_DOMAIN};
    fi
    ;;

  "reset" )
    sudo echo "RESETING RELEVANT FEATURE(S)";

    if [[ "${DOMAIN}" != "${NULL}" ]]; then
      echo "Reseting the primary domain name for '${PROJECT_NAME}' will DELETE all aliases.";
      read -p "ARE YOU SURE YOU WISH TO CONTINUE WITH THIS ACTION (y/n)?" -n 1 -r
      if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo " ...RESETTING PRIMARY DOMAIN NAME.";
        sudo virtualhost ${PROJECT_NAME} remove;
        sudo virtualhost ${PROJECT_NAME} add ${DOMAIN};
        if [[ -d "${HOME}/Projects/${PROJECT_NAME}/copy" ]]; then
          echo "ADDING SUB DOMAIN: copy.${DOMAIN}";
          sudo /bin/ln -s "${HOME}/Projects/${PROJECT_NAME}/copy" "/var/www/copy.${DOMAIN}";
          sudo virtualhost-append-copy ${HOST} ${DOMAIN};
        fi
        echo "RELOADING WEB SERVER";
        sudo a2ensite ${HOST} && sudo service apache2 reload
      fi
      echo;
    fi

    if [[ ${APPLICATION_NAME} = TRUE ]]; then
      echo "Reseting web application skeleton '${HOME}/Projects/${PROJECT_NAME}', will REMOVE developer added files.";
      read -p "ARE YOU SURE YOU WISH TO CONTINUE WITH THIS ACTION (y/n)?" -n 1 -r
      if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo " ...RESETTING WEB APPLICATION SKELETON.";
        /bin/cp -dRvfi /etc/webshop/skel/application/* "${HOME}/Projects/${PROJECT_NAME}";
      fi
      echo;
    fi

    if [[ "${COPY_DOMAIN}" != "${NULL}" ]]; then
      copy-current-website "${PROJECT_NAME}" ${COPY_DOMAIN};
    fi
    ;;
esac

echo "PROCESS SUCCESFULLY COMPLETED!";
exit 0;
